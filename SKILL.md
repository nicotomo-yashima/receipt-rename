---
name: receipt-rename
description: >
  ScanSnap等でスキャンしたレシート/領収書PDFのファイル名を、
  中身を読み取って「YYYYMMDD_店名_金額.pdf」形式に修正するスキル。
  /receipt-rename で実行。対象フォルダ指定も可。
  Triggers on: receipt-rename, レシートリネーム, レシート整理, 領収書リネーム
argument-hint: "[フォルダパス]"
allowed-tools: Read, Glob, Bash(pdftoppm *), Bash(mkdir *), Bash(mv *), Bash(rm *), Bash(which *), Bash(brew install *), AskUserQuestion
---

# Receipt Rename - レシートPDFリネームスキル

スキャンしたレシート/領収書PDFのファイル名を、実際の内容に基づいて修正する。

---

## 命名規則

```
YYYYMMDD_店名_金額.pdf
```

- **日付**: レシートに印字された日付（スキャン日ではない）。`YYYYMMDD` 形式
- **店名**: 店舗名。正式名称から適度に省略可（「株式会社」等は省略してよい）
- **金額**: 合計金額（税込）。数字のみ、カンマなし

---

## 実行手順

### 1. 前提確認

`pdftoppm` の存在を確認する。なければ `brew install poppler` でインストール。

```bash
which pdftoppm || brew install poppler
```

### 2. 対象フォルダ決定

- 引数でフォルダパスが指定されていればそれを使う
- 指定なしの場合、カレントディレクトリを使用
- フォルダが存在しなければユーザーに確認

### 3. PDFファイル一覧取得

Glob で `*.pdf` を検索し、一覧を取得する。

### 4. PDF読み取り＆照合（バッチ処理）

**効率化のため、6ファイルずつ並列で処理する。**

各PDFに対して:

1. **PNG変換**: `pdftoppm -png -r 200 -f 1 -l 1 "<pdf>" /tmp/receipt_rename/<id>` で1ページ目を画像化
2. **画像読み取り**: Read ツールでPNG画像を読み、以下を抽出:
   - **日付**: レシートに印字された取引日（和暦の場合は西暦に変換）
   - **店名**: 店舗名・屋号（ロゴ・ヘッダー・フッターから判別）
   - **金額**: 合計金額（「合計」「合計金額」「領収金額」欄の値）
3. **ファイル名照合**: 現在のファイル名と読み取り結果を比較

### 5. 判定基準

各項目を以下で判定:

| 項目 | 正しい条件 |
|------|-----------|
| 日付 | YYYYMMDD が実際の取引日と一致 |
| 店名 | 実際の店舗を特定できる名前になっている |
| 金額 | 合計金額（税込）と一致 |

**よくあるOCR誤りパターン（注意して検出）:**
- 日付がスキャン実行日になっている（レシートの取引日ではない）
- 店名が `株式会社` だけ、`(金額)` のまま、意味不明な文字列
- 金額が `(金額)` のまま、桁が違う

### 6. リネーム実行

照合結果をテーブル形式でユーザーに表示し、確認後にリネーム実行。

```bash
mv "旧ファイル名.pdf" "新ファイル名.pdf"
```

### 7. 読み取り不能な場合のフォールバック

情報が判読できない場合は、以下の命名で暫定リネーム:

| 状況 | 命名例 |
|------|--------|
| 日付不明 | `(日付不明)_店名_金額.pdf` |
| 店名不明 | `YYYYMMDD_(店名不明)_金額.pdf` |
| 金額不明 | `YYYYMMDD_店名_(金額不明).pdf` |
| 手書き領収書で複数不明 | `(日付不明)_店名_(金額不明).pdf` |

### 8. 完了レポート

最後に以下を出力:

- 修正済みファイル数 / 全ファイル数
- 元から正しかったファイル一覧
- 修正したファイルの旧→新ファイル名一覧
- 要手動確認ファイル一覧（フォールバック命名のもの）

### 9. クリーンアップ

一時ファイルを削除:

```bash
rm -rf /tmp/receipt_rename
```

---

## 出力フォーマット例

```
## レシートリネーム結果

### 修正済み（5件）
| # | 旧ファイル名 | 新ファイル名 |
|---|---|---|
| 1 | 20260101_株式会社_(金額) | 20250315_サイゼリヤ渋谷店_1200 |
| 2 | 20260101_<領収書>_500 | 20250320_スターバックス新宿店_500 |
| ... | ... | ... |

### 元から正しかった（2件）
- 20250401_ローソン駅前店_350

### 要手動確認（1件）
- (日付不明)_手書き居酒屋_(金額不明).pdf — 手書き領収書
```

---

## 注意事項

- リネーム前に必ずユーザーに確認を取ること
- 同名ファイルが既に存在する場合は末尾に `_2` 等を付けて回避
- 画像が暗い・ぼやけている場合は解像度を `-r 300` に上げて再試行
- 和暦→西暦の変換: 令和1年=2019, 令和2年=2020, ... 令和8年=2026
